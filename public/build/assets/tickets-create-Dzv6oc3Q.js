document.addEventListener("DOMContentLoaded",function(){L()});function L(){console.log("üé´ Inicializando funcionalidad de Crear Ticket");const t=_();console.log(`üìù Tipo de ticket: ${t}`),B(),A(),$(),t==="mantenimiento"&&(console.log("üîß Es ticket de mantenimiento, inicializando calendario..."),C())}function C(){const t=document.getElementById("maintenanceScheduling");if(!t){console.log("‚ùå No hay elemento de scheduling");return}const n=document.getElementById("calendarGrid"),e=document.getElementById("calendarMonthLabel"),s=document.getElementById("calendarPrev"),b=document.getElementById("calendarNext"),g=t.getAttribute("data-availability-url"),p=t.getAttribute("data-slots-url");if(!n||!e){console.error("‚ùå Elementos del calendario no encontrados");return}if(!g||!p){console.error("‚ùå URLs de API no configuradas");return}console.log("‚úÖ Elementos encontrados, inicializando calendario con disponibilidad..."),console.log("üîó URLs:",{availabilityUrl:g,slotsUrl:p});let m=new Date,c={};async function v(){try{console.log("üîÑ Cargando disponibilidad...");const a=m.toISOString().substr(0,7),l=`${g}?month=${a}`;console.log("üì° Consultando API:",l);const o=await fetch(l);if(!o.ok){if(console.error("‚ùå API Error. Status:",o.status,o.statusText),window.forceRealAPI){u(`Error de API: ${o.status} - ${o.statusText}`,"error");return}console.warn("Usando datos de prueba como fallback"),c=E(),console.log("üìä Usando datos de prueba:",c),w();return}const i=await o.json();console.log("üìä Datos de API recibidos:",i),c={},i.days&&Array.isArray(i.days)&&i.days.forEach(d=>{c[d.date]=d}),console.log("üìä Disponibilidad procesada:",c),w()}catch(a){if(console.error("‚ùå Error cargando disponibilidad:",a),window.forceRealAPI){u(`Error de conexi√≥n: ${a.message}`,"error");return}console.log("Usando datos de prueba como fallback"),c=E(),u("Usando datos de prueba (API no disponible)","info"),w()}}function E(){const a=new Date,l={};for(let o=0;o<30;o++){const i=new Date(a);i.setDate(a.getDate()+o);const d=i.toISOString().split("T")[0];o%4===0?l[d]={available_slots:4,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!0},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!0},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:o%4===1?l[d]={available_slots:2,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:o%4===2&&(l[d]={available_slots:0,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!1},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!1}]})}return l}function w(){console.log("üé® Renderizando mes con disponibilidad...");const a=m.toLocaleDateString("es-ES",{month:"long",year:"numeric"});e.textContent=a.charAt(0).toUpperCase()+a.slice(1),n.innerHTML="";const l=new Date(m.getFullYear(),m.getMonth(),1),o=new Date(l);o.setDate(o.getDate()-l.getDay());const i=new Date;i.setHours(0,0,0,0);for(let d=0;d<35;d++){const f=new Date(o);f.setDate(o.getDate()+d);const r=document.createElement("button");r.type="button",r.textContent=f.getDate(),r.className="h-10 w-full rounded-lg text-sm font-medium transition-colors";const x=f.toISOString().split("T")[0],h=c[x],y=f.getMonth()===m.getMonth(),T=f<i;y?T?(r.className+=" text-gray-400 bg-gray-100 cursor-not-allowed",r.disabled=!0):h?h.available_slots>0?(r.className+=" bg-green-100 text-green-800 hover:bg-green-200 border border-green-200",r.addEventListener("click",()=>k(x,f))):h.total_slots>0?(r.className+=" bg-yellow-100 text-yellow-800 cursor-not-allowed border border-yellow-200",r.disabled=!0):(r.className+=" text-gray-400 cursor-not-allowed bg-gray-100",r.disabled=!0):(r.className+=" bg-red-100 text-red-800 cursor-not-allowed border border-red-200",r.disabled=!0):(r.className+=" text-gray-300 bg-gray-50 cursor-not-allowed",r.disabled=!0),n.appendChild(r)}console.log("üìÖ Calendario renderizado con disponibilidad")}async function k(a,l){try{console.log("üìÖ Cargando horarios para:",a);const o=await fetch(`${p}?date=${a}`);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const i=await o.json();console.log("‚è∞ Horarios cargados:",i),S(i,a,l)}catch(o){console.error("‚ùå Error cargando horarios:",o),u("Error al cargar los horarios disponibles","error")}}function S(a,l,o){const i=document.getElementById("timeSlotsWrapper"),d=document.getElementById("timeSlotsList"),f=document.getElementById("selectedDateLabel"),r=document.getElementById("noSlotsMessage");if(!i||!d){console.error("‚ùå Elementos de horarios no encontrados");return}const x=o.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});if(f&&(f.textContent=x.charAt(0).toUpperCase()+x.slice(1)),d.innerHTML="",a.length===0){r&&r.classList.remove("hidden"),i.classList.add("hidden");return}r&&r.classList.add("hidden"),a.forEach(h=>{const y=document.createElement("button");y.type="button",y.className=`p-4 rounded-2xl border-2 transition-all text-left hover:scale-105 ${h.available_capacity>0?"border-green-200 bg-green-50 hover:border-green-300 hover:bg-green-100":"border-gray-200 bg-gray-50 cursor-not-allowed opacity-50"}`,y.innerHTML=`
                <div class="font-semibold text-slate-900">${h.start_time} - ${h.end_time}</div>
                <div class="text-sm text-slate-600 mt-1">
                    Disponibles: ${h.available_capacity}/${h.capacity}
                </div>
            `,h.available_capacity>0?y.addEventListener("click",()=>D(h,l)):y.disabled=!0,d.appendChild(y)}),i.classList.remove("hidden"),console.log("‚è∞ Horarios mostrados:",a.length)}function D(a,l){console.log("‚è∞ Horario seleccionado:",a);const o=document.getElementById("maintenance_slot_id"),i=document.getElementById("maintenance_selected_date"),d=document.getElementById("selectedSlotLabel");o&&(o.value=a.id),i&&(i.value=l),d&&(d.textContent=`Horario: ${a.start_time} - ${a.end_time}`),document.querySelectorAll("#timeSlotsList button").forEach(f=>{f.classList.remove("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),f.classList.add("border-green-200","bg-green-50")}),event.target.closest("button").classList.remove("border-green-200","bg-green-50"),event.target.closest("button").classList.add("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),u(`Horario seleccionado: ${a.start_time} - ${a.end_time}`,"success")}s&&s.addEventListener("click",()=>{console.log("‚¨ÖÔ∏è Mes anterior"),m.setMonth(m.getMonth()-1),w(),I()}),b&&b.addEventListener("click",()=>{console.log("‚û°Ô∏è Mes siguiente"),m.setMonth(m.getMonth()+1),w(),I()});function I(){const a=document.getElementById("timeSlotsWrapper"),l=document.getElementById("selectedSlotLabel"),o=document.getElementById("maintenance_slot_id"),i=document.getElementById("maintenance_selected_date");a&&a.classList.add("hidden"),l&&(l.textContent=""),o&&(o.value=""),i&&(i.value="")}v()}function _(){const t=document.querySelector("[data-ticket-type]");return t?t.getAttribute("data-ticket-type"):"unknown"}function u(t,n="info"){const e=document.createElement("div"),s=n==="success"?"bg-green-500":n==="error"?"bg-red-500":n==="warning"?"bg-yellow-500":"bg-blue-500";e.className=`fixed top-4 right-4 ${s} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{e.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},4e3)}function B(){const t=document.querySelector("[data-ticket-create] form");t&&t.addEventListener("submit",function(n){if(!M())return n.preventDefault(),!1;const e=t.querySelector('button[type="submit"]');if(e){const s=e.textContent;e.disabled=!0,e.innerHTML=`
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creando ticket...
            `,setTimeout(()=>{e.disabled=!1,e.textContent=s},1e4)}})}function M(){const t=_();let n=!0;const e=document.getElementById("descripcion_problema");if(e&&t!=="mantenimiento"&&(e.value.trim()||(u("La descripci√≥n del problema es obligatoria","error"),e.focus(),n=!1)),t==="software"){const s=document.getElementById("nombre_programa");s&&!s.value&&(u("Debes seleccionar un programa","error"),s.focus(),n=!1)}if(t==="mantenimiento"){const s=document.getElementById("maintenance_slot_id");s&&!s.value&&(u("Debes seleccionar una fecha y horario para el mantenimiento","error"),n=!1)}return n}function $(){const t=document.getElementById("nombre_programa"),n=document.getElementById("otro_programa_nombre");if(!t||!n)return;function e(){const s=t.value==="Otro",b=n.closest("div");b&&(s?(b.style.display="block",n.required=!0,setTimeout(()=>n.focus(),100)):(b.style.display="none",n.required=!1,n.value=""))}t.addEventListener("change",e),e()}function A(){const t=document.getElementById("imageInput"),n=document.getElementById("imagePreview");if(document.querySelector(`button[onclick="document.getElementById('imageInput').click()"]`),!t||!n)return;let e=[];t.addEventListener("change",function(g){const m=Array.from(g.target.files).filter(c=>c.size>10*1024*1024?(u(`La imagen "${c.name}" es muy grande (m√°ximo 10MB)`,"warning"),!1):c.type.startsWith("image/")?!0:(u(`"${c.name}" no es una imagen v√°lida`,"warning"),!1));e=[...e,...m],e.length>10&&(e=e.slice(0,10),u("M√°ximo 10 im√°genes permitidas","warning")),s(),b()});function s(){if(e.length===0){n.innerHTML='<p class="text-sm text-slate-400 text-center py-8">Las im√°genes seleccionadas aparecer√°n aqu√≠</p>';return}n.innerHTML="",e.forEach((g,p)=>{const m=new FileReader;m.onload=function(c){const v=document.createElement("div");v.className="relative group",v.innerHTML=`
                    <img src="${c.target.result}" alt="Preview ${p+1}" 
                         class="h-24 w-24 rounded-xl object-cover shadow-md transition group-hover:shadow-lg">
                    <button type="button" 
                            onclick="removeImage(${p})"
                            class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-white shadow-lg transition hover:bg-red-600 hover:scale-110">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition rounded-xl flex items-center justify-center">
                        <span class="text-white text-xs font-medium">Ver</span>
                    </div>
                `,v.querySelector("img").addEventListener("click",()=>N(c.target.result,`Imagen ${p+1}`)),n.appendChild(v)},m.readAsDataURL(g)})}function b(){const g=new DataTransfer;e.forEach(p=>{p&&g.items.add(p)}),t.files=g.files}window.removeImage=function(g){e.splice(g,1),s(),b(),e.length===0&&u("Imagen eliminada","info")}}function N(t,n){let e=document.getElementById("imageExpandModal");e||(e=z());const s=e.querySelector("#expandedImage"),b=e.querySelector("#expandedImageTitle");s.src=t,s.alt=n,b.textContent=n,e.classList.remove("hidden"),e.classList.add("flex"),document.body.style.overflow="hidden"}function z(){const t=document.createElement("div");return t.id="imageExpandModal",t.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",t.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeExpandedImage()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="expandedImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="expandedImageTitle" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.addEventListener("keydown",function(n){n.key==="Escape"&&!t.classList.contains("hidden")&&closeExpandedImage()}),t.addEventListener("click",function(n){n.target===t&&closeExpandedImage()}),document.body.appendChild(t),t}window.closeExpandedImage=function(){const t=document.getElementById("imageExpandModal");t&&(t.classList.add("hidden"),t.classList.remove("flex"),document.body.style.overflow="")};window.initializeTicketCreate=L;window.showNotification=u;window.closeExpandedImage=closeExpandedImage;console.log("‚úÖ Tickets-create.js cargado correctamente");
