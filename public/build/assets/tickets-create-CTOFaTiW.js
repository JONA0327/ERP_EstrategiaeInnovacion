document.addEventListener("DOMContentLoaded",function(){k()});function k(){console.log("üé´ Inicializando funcionalidad de Crear Ticket");const t=T();console.log(`üìù Tipo de ticket: ${t}`),$(),z(),N(),t==="mantenimiento"&&(console.log("üîß Es ticket de mantenimiento, inicializando calendario..."),M())}function M(){const t=document.getElementById("maintenanceScheduling");if(!t){console.log("‚ùå No hay elemento de scheduling");return}const o=document.getElementById("calendarGrid"),e=document.getElementById("calendarMonthLabel"),r=document.getElementById("calendarPrev"),p=document.getElementById("calendarNext"),b=t.getAttribute("data-availability-url"),h=t.getAttribute("data-slots-url");if(!o||!e){console.error("‚ùå Elementos del calendario no encontrados");return}if(!b||!h){console.error("‚ùå URLs de API no configuradas");return}console.log("‚úÖ Elementos encontrados, inicializando calendario con disponibilidad..."),console.log("üîó URLs:",{availabilityUrl:b,slotsUrl:h});let g=new Date,m={};async function v(){try{console.log("üîÑ Cargando disponibilidad...");const n=g.toISOString().substr(0,7),c=`${b}?month=${n}`;console.log("üì° Consultando API:",c);const a=await fetch(c);if(!a.ok){if(console.error("‚ùå API Error. Status:",a.status,a.statusText),window.forceRealAPI){f(`Error de API: ${a.status} - ${a.statusText}`,"error");return}console.warn("Usando datos de prueba como fallback"),m=I(),console.log("üìä Usando datos de prueba:",m),x();return}const s=await a.json();console.log("üìä Datos de API recibidos:",s),m={},s.days&&Array.isArray(s.days)&&s.days.forEach(d=>{m[d.date]=d}),console.log("üìä Disponibilidad procesada:",m),x()}catch(n){if(console.error("‚ùå Error cargando disponibilidad:",n),window.forceRealAPI){f(`Error de conexi√≥n: ${n.message}`,"error");return}console.log("Usando datos de prueba como fallback"),m=I(),f("Usando datos de prueba (API no disponible)","info"),x()}}function I(){const n=new Date,c={};for(let a=0;a<30;a++){const s=new Date(n);s.setDate(n.getDate()+a);const d=s.toISOString().split("T")[0];a%4===0?c[d]={available_slots:4,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!0},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!0},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:a%4===1?c[d]={available_slots:2,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:a%4===2&&(c[d]={available_slots:0,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!1},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!1}]})}return c}function x(){console.log("üé® Renderizando mes con disponibilidad...");const n=g.toLocaleDateString("es-ES",{month:"long",year:"numeric"});e.textContent=n.charAt(0).toUpperCase()+n.slice(1),o.innerHTML="";const c=new Date(g.getFullYear(),g.getMonth(),1),a=new Date(c);a.setDate(a.getDate()-c.getDay());const s=new Date;s.setHours(0,0,0,0);for(let d=0;d<35;d++){const u=new Date(a);u.setDate(a.getDate()+d);const i=document.createElement("button");i.type="button",i.textContent=u.getDate(),i.className="h-10 w-full rounded-lg text-sm font-medium transition-colors";const w=u.toISOString().split("T")[0],l=m[w],y=u.getMonth()===g.getMonth(),E=u<s;y?E?(i.className+=" text-gray-400 bg-gray-100 cursor-not-allowed",i.disabled=!0):l?l.available_slots>0?(i.className+=" bg-green-100 text-green-800 hover:bg-green-200 border border-green-200",i.addEventListener("click",()=>L(w,u))):l.total_slots>0&&l.booked>0&&l.booked<l.total_capacity?(i.className+=" bg-yellow-100 text-yellow-800 hover:bg-yellow-200 border border-yellow-200",i.addEventListener("click",()=>L(w,u))):l.total_slots>0?(i.className+=" bg-blue-100 text-blue-800 cursor-not-allowed border border-blue-200",i.disabled=!0):(i.className+=" text-gray-400 cursor-not-allowed bg-gray-100",i.disabled=!0):(i.className+=" bg-red-100 text-red-800 cursor-not-allowed border border-red-200",i.disabled=!0):(i.className+=" text-gray-300 bg-gray-50 cursor-not-allowed",i.disabled=!0),o.appendChild(i)}console.log("üìÖ Calendario renderizado con disponibilidad")}async function L(n,c){try{console.log("üìÖ Cargando horarios para:",n);const a=await fetch(`${h}?date=${n}`);if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const s=await a.json();console.log("‚è∞ Horarios cargados:",s);const d=s.slots||[];console.log("üìã Slots procesados:",d),S(d,n,c)}catch(a){console.error("‚ùå Error cargando horarios:",a),f("Error al cargar los horarios disponibles","error")}}function S(n,c,a){const s=document.getElementById("timeSlotsWrapper"),d=document.getElementById("timeSlotsList"),u=document.getElementById("selectedDateLabel"),i=document.getElementById("noSlotsMessage");if(!s||!d){console.error("‚ùå Elementos de horarios no encontrados");return}const w=a.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});if(u&&(u.textContent=w.charAt(0).toUpperCase()+w.slice(1)),d.innerHTML="",n.length===0){i&&i.classList.remove("hidden"),s.classList.add("hidden");return}if(i&&i.classList.add("hidden"),!Array.isArray(n)){console.error("‚ùå slots no es un array:",typeof n,n),i&&i.classList.remove("hidden"),s.classList.add("hidden");return}console.log("‚úÖ Creando botones para",n.length,"horarios"),n.forEach(l=>{console.log("üïí Procesando slot (primera funci√≥n):",l);const y=document.createElement("button");y.type="button";const E=l.available>0||l.status==="available",C=l.start||l.start_time,B=l.end||l.end_time;y.className=`p-4 rounded-2xl border-2 transition-all text-left hover:scale-105 ${E?"border-green-200 bg-green-50 hover:border-green-300 hover:bg-green-100":"border-gray-200 bg-gray-50 cursor-not-allowed opacity-50"}`,y.innerHTML=`
                <div class="font-semibold text-slate-900">${C} - ${B}</div>
                <div class="text-sm text-slate-600 mt-1">
                    Disponibles: ${l.available||0}/${l.capacity||1}
                </div>
                <div class="text-xs mt-1">
                    Estado: <span class="${l.status==="available"?"text-green-600":l.status==="partial"?"text-yellow-600":"text-red-600"}">${l.status||"unknown"}</span>
                </div>
            `,E?y.addEventListener("click",()=>D(l,c)):y.disabled=!0,d.appendChild(y)}),s.classList.remove("hidden"),console.log("‚è∞ Horarios mostrados:",n.length)}function D(n,c){console.log("‚è∞ Horario seleccionado:",n);const a=document.getElementById("maintenance_slot_id"),s=document.getElementById("maintenance_selected_date"),d=document.getElementById("selectedSlotLabel");if(a&&(a.value=n.id),s&&(s.value=c),d){const u=n.start||n.start_time||"N/A",i=n.end||n.end_time||"N/A";d.textContent=`Horario: ${u} - ${i}`}document.querySelectorAll("#timeSlotsList button").forEach(u=>{u.classList.remove("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),u.classList.add("border-green-200","bg-green-50")}),event.target.closest("button").classList.remove("border-green-200","bg-green-50"),event.target.closest("button").classList.add("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),f(`Horario seleccionado: ${n.start_time} - ${n.end_time}`,"success")}r&&r.addEventListener("click",()=>{console.log("‚¨ÖÔ∏è Mes anterior"),g.setMonth(g.getMonth()-1),x(),_()}),p&&p.addEventListener("click",()=>{console.log("‚û°Ô∏è Mes siguiente"),g.setMonth(g.getMonth()+1),x(),_()});function _(){const n=document.getElementById("timeSlotsWrapper"),c=document.getElementById("selectedSlotLabel"),a=document.getElementById("maintenance_slot_id"),s=document.getElementById("maintenance_selected_date");n&&n.classList.add("hidden"),c&&(c.textContent=""),a&&(a.value=""),s&&(s.value="")}v()}function T(){const t=document.querySelector("[data-ticket-type]");return t?t.getAttribute("data-ticket-type"):"unknown"}function f(t,o="info"){const e=document.createElement("div"),r=o==="success"?"bg-green-500":o==="error"?"bg-red-500":o==="warning"?"bg-yellow-500":"bg-blue-500";e.className=`fixed top-4 right-4 ${r} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{e.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},4e3)}function $(){const t=document.querySelector("[data-ticket-create] form");t&&t.addEventListener("submit",function(o){if(!A())return o.preventDefault(),!1;const e=t.querySelector('button[type="submit"]');if(e){const r=e.textContent;e.disabled=!0,e.innerHTML=`
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creando ticket...
            `,setTimeout(()=>{e.disabled=!1,e.textContent=r},1e4)}})}function A(){const t=T();let o=!0;const e=document.getElementById("descripcion_problema");if(e&&t!=="mantenimiento"&&(e.value.trim()||(f("La descripci√≥n del problema es obligatoria","error"),e.focus(),o=!1)),t==="software"){const r=document.getElementById("nombre_programa");r&&!r.value&&(f("Debes seleccionar un programa","error"),r.focus(),o=!1)}if(t==="mantenimiento"){const r=document.getElementById("maintenance_slot_id");r&&!r.value&&(f("Debes seleccionar una fecha y horario para el mantenimiento","error"),o=!1)}return o}function N(){const t=document.getElementById("nombre_programa"),o=document.getElementById("otro_programa_nombre");if(!t||!o)return;function e(){const r=t.value==="Otro",p=o.closest("div");p&&(r?(p.style.display="block",o.required=!0,setTimeout(()=>o.focus(),100)):(p.style.display="none",o.required=!1,o.value=""))}t.addEventListener("change",e),e()}function z(){const t=document.getElementById("imageInput"),o=document.getElementById("imagePreview");if(document.querySelector(`button[onclick="document.getElementById('imageInput').click()"]`),!t||!o)return;let e=[];t.addEventListener("change",function(b){const g=Array.from(b.target.files).filter(m=>m.size>10*1024*1024?(f(`La imagen "${m.name}" es muy grande (m√°ximo 10MB)`,"warning"),!1):m.type.startsWith("image/")?!0:(f(`"${m.name}" no es una imagen v√°lida`,"warning"),!1));e=[...e,...g],e.length>10&&(e=e.slice(0,10),f("M√°ximo 10 im√°genes permitidas","warning")),r(),p()});function r(){if(e.length===0){o.innerHTML='<p class="text-sm text-slate-400 text-center py-8">Las im√°genes seleccionadas aparecer√°n aqu√≠</p>';return}o.innerHTML="",e.forEach((b,h)=>{const g=new FileReader;g.onload=function(m){const v=document.createElement("div");v.className="relative group",v.innerHTML=`
                    <img src="${m.target.result}" alt="Preview ${h+1}" 
                         class="h-24 w-24 rounded-xl object-cover shadow-md transition group-hover:shadow-lg">
                    <button type="button" 
                            onclick="removeImage(${h})"
                            class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-white shadow-lg transition hover:bg-red-600 hover:scale-110">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition rounded-xl flex items-center justify-center">
                        <span class="text-white text-xs font-medium">Ver</span>
                    </div>
                `,v.querySelector("img").addEventListener("click",()=>H(m.target.result,`Imagen ${h+1}`)),o.appendChild(v)},g.readAsDataURL(b)})}function p(){const b=new DataTransfer;e.forEach(h=>{h&&b.items.add(h)}),t.files=b.files}window.removeImage=function(b){e.splice(b,1),r(),p(),e.length===0&&f("Imagen eliminada","info")}}function H(t,o){let e=document.getElementById("imageExpandModal");e||(e=P());const r=e.querySelector("#expandedImage"),p=e.querySelector("#expandedImageTitle");r.src=t,r.alt=o,p.textContent=o,e.classList.remove("hidden"),e.classList.add("flex"),document.body.style.overflow="hidden"}function P(){const t=document.createElement("div");return t.id="imageExpandModal",t.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",t.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeExpandedImage()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="expandedImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="expandedImageTitle" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.addEventListener("keydown",function(o){o.key==="Escape"&&!t.classList.contains("hidden")&&closeExpandedImage()}),t.addEventListener("click",function(o){o.target===t&&closeExpandedImage()}),document.body.appendChild(t),t}window.closeExpandedImage=function(){const t=document.getElementById("imageExpandModal");t&&(t.classList.add("hidden"),t.classList.remove("flex"),document.body.style.overflow="")};window.initializeTicketCreate=k;window.showNotification=f;window.closeExpandedImage=closeExpandedImage;console.log("‚úÖ Tickets-create.js cargado correctamente");
