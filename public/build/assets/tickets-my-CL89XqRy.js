document.addEventListener("DOMContentLoaded",function(){y()});function y(){C(),L(),M()}function C(){let e=document.getElementById("imageModal");e||(e=T()),document.addEventListener("keydown",function(c){c.key==="Escape"&&e&&!e.classList.contains("hidden")&&E()}),e&&e.addEventListener("click",function(c){c.target===e&&E()})}function T(){const e=document.createElement("div");return e.id="imageModal",e.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",e.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeImageModal()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="modalImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="modalImageName" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.body.appendChild(e),e}function I(e){const c=document.getElementById("imageModal"),n=document.getElementById("modalImage"),u=document.getElementById("modalImageName");c&&n&&(n.src=e.src,n.alt=e.alt,u&&(u.textContent=e.alt||"Imagen del ticket"),c.classList.remove("hidden"),c.classList.add("flex"))}function E(){const e=document.getElementById("imageModal");e&&(e.classList.add("hidden"),e.classList.remove("flex"))}function L(){const e=document.getElementById("cancelModal"),c=document.getElementById("cancelModalClose"),n=document.getElementById("cancelModalConfirm"),u=document.getElementById("cancelModalMessage");let o=null,t=null,i=null,g=null;document.addEventListener("click",async function(m){const s=m.target.closest("[data-cancel-ticket]");if(s){m.preventDefault(),o=s.dataset.ticketId,t=s.dataset.ticketFolio,i=s.dataset.canCancelUrl||`${window.location.origin}/ticket/${o}/can-cancel`,g=s.dataset.cancelUrl||`${window.location.origin}/ticket/${o}`;try{const a=await fetch(i,{credentials:"same-origin"});if(!a.ok){if(a.status===404){r(`El ticket ${t} no fue encontrado.`,"error");return}else if(a.status===403){r(`No tienes permisos para cancelar el ticket ${t}. Solo el propietario o un administrador pueden hacerlo.`,"error");return}throw new Error(`HTTP ${a.status}: ${a.statusText}`)}const f=await a.json();if(!f.can_cancel){let d=`No se puede cancelar el ticket ${t}.`;switch(f.reason){case"Sin permisos":d+=" No tienes permisos suficientes.";break;case"Ya cancelado":d+=" El ticket ya fue cancelado anteriormente.";break;case"Fecha ya pasó":d+=` La fecha de mantenimiento (${f.maintenance_date}) ya ha pasado.`;break;default:d+=` Razón: ${f.reason}`}r(d,"error");return}}catch(a){console.error("Error verificando si se puede cancelar:",a),r("Error al verificar el ticket. Intenta nuevamente.","error");return}u&&(u.textContent=`¿Estás seguro que deseas cancelar el ticket ${t}? Esta acción no se puede deshacer.`),e&&(e.classList.remove("hidden"),e.classList.add("flex"))}}),c&&c.addEventListener("click",p),n&&n.addEventListener("click",function(){o&&h(o)}),e&&(document.addEventListener("keydown",function(m){m.key==="Escape"&&!e.classList.contains("hidden")&&p()}),e.addEventListener("click",function(m){m.target===e&&p()}));function p(){e&&(e.classList.add("hidden"),e.classList.remove("flex")),o=null,t=null,i=null,g=null}async function h(m){try{n&&(n.disabled=!0,n.textContent="Cancelando...");const s=g||`${window.location.origin}/ticket/${m}`;console.log("Attempting DELETE request to:",s),console.log("currentCancelUrl:",g),console.log("ticketId:",m);const a=document.createElement("form");a.method="POST",a.action=s,a.style.display="none";const f=document.createElement("input");f.type="hidden",f.name="_token",f.value=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",a.appendChild(f);const d=document.createElement("input");d.type="hidden",d.name="_method",d.value="DELETE",a.appendChild(d),document.body.appendChild(a);const l=new XMLHttpRequest;l.open("POST",s,!0),l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.setRequestHeader("X-CSRF-TOKEN",document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"");const w=new FormData;w.append("_token",document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""),w.append("_method","DELETE");const k=await new Promise((v,x)=>{l.onload=function(){v({ok:l.status>=200&&l.status<300,status:l.status,statusText:l.statusText,json:()=>{try{return Promise.resolve(JSON.parse(l.responseText))}catch{return Promise.resolve({})}}})},l.onerror=()=>x(new Error("Network error")),l.send(w)});if(document.body.removeChild(a),k.ok)p(),r("Ticket cancelado exitosamente","success"),setTimeout(()=>{window.location.reload()},1500);else if(k.status===404)r("El ticket no fue encontrado.","error");else if(k.status===403)r("No tienes permisos para cancelar este ticket.","error");else throw new Error(`HTTP ${k.status}: ${k.statusText}`)}catch(s){console.error("Error:",s),r("Error al cancelar el ticket. Inténtalo de nuevo.","error")}finally{n&&(n.disabled=!1,n.textContent="Aceptar")}}}function M(){document.addEventListener("click",function(o){const t=o.target.closest("[data-acknowledge-update]");if(t){o.preventDefault();const i=t.dataset.ticketId;i&&c(i,t)}});const e=document.querySelector("[data-acknowledge-all]");e&&e.addEventListener("click",function(o){o.preventDefault(),n(this)});async function c(o,t){try{const i=t.textContent;if(t.disabled=!0,t.textContent="Marcando...",(await fetch(`${window.location.origin}/ticket/${o}/acknowledge-update`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}})).ok){const p=t.closest("[data-ticket-card]");if(p){const h=p.querySelector("[data-update-indicator]");h&&h.remove()}t.remove(),r("Actualización marcada como revisada","success"),u()}else throw new Error("Error al marcar como revisado")}catch(i){console.error("Error:",i),r("Error al marcar como revisado","error"),t.disabled=!1,t.textContent=originalText}}async function n(o){try{const t=o.textContent;if(o.disabled=!0,o.textContent="Marcando todos...",(await fetch(`${window.location.origin}/tickets/acknowledge-all`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}})).ok)r("Todas las actualizaciones marcadas como revisadas","success"),setTimeout(()=>{window.location.reload()},1500);else throw new Error("Error al marcar todos como revisados")}catch(t){console.error("Error:",t),r("Error al marcar todos como revisados","error"),o.disabled=!1,o.textContent=originalText}}function u(){const t=document.querySelectorAll("[data-update-indicator]").length,i=document.querySelector("[data-notification-count]");i&&(t>0?(i.textContent=t,i.classList.remove("hidden")):i.classList.add("hidden"))}}function r(e,c="info"){const n=document.createElement("div"),u=c==="success"?"bg-green-500":c==="error"?"bg-red-500":"bg-blue-500";n.className=`fixed top-4 right-4 ${u} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{n.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},4e3)}window.initializeMyTickets=y;window.expandImage=I;window.closeImageModal=E;window.showNotification=r;
