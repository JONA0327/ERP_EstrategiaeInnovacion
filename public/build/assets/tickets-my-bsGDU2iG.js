document.addEventListener("DOMContentLoaded",function(){p()});function p(){k(),E(),v()}function k(){let e=document.getElementById("imageModal");e||(e=h()),document.addEventListener("keydown",function(c){c.key==="Escape"&&e&&!e.classList.contains("hidden")&&f()}),e&&e.addEventListener("click",function(c){c.target===e&&f()})}function h(){const e=document.createElement("div");return e.id="imageModal",e.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",e.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeImageModal()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="modalImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="modalImageName" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.body.appendChild(e),e}function w(e){const c=document.getElementById("imageModal"),a=document.getElementById("modalImage"),d=document.getElementById("modalImageName");c&&a&&(a.src=e.src,a.alt=e.alt,d&&(d.textContent=e.alt||"Imagen del ticket"),c.classList.remove("hidden"),c.classList.add("flex"))}function f(){const e=document.getElementById("imageModal");e&&(e.classList.add("hidden"),e.classList.remove("flex"))}function E(){const e=document.getElementById("cancelModal"),c=document.getElementById("cancelModalClose"),a=document.getElementById("cancelModalConfirm"),d=document.getElementById("cancelModalMessage");let o=null,t=null;document.addEventListener("click",async function(s){const i=s.target.closest("[data-cancel-ticket]");if(i){s.preventDefault(),o=i.dataset.ticketId,t=i.dataset.ticketFolio;try{const l=await fetch(`${window.location.origin}/ticket/${o}/can-cancel`);if(!l.ok){if(l.status===404){r(`El ticket ${t} no fue encontrado.`,"error");return}else if(l.status===403){r(`No tienes permisos para cancelar el ticket ${t}. Solo el propietario o un administrador pueden hacerlo.`,"error");return}throw new Error(`HTTP ${l.status}: ${l.statusText}`)}const m=await l.json();if(!m.can_cancel){let u=`No se puede cancelar el ticket ${t}.`;switch(m.reason){case"Sin permisos":u+=" No tienes permisos suficientes.";break;case"Ya cancelado":u+=" El ticket ya fue cancelado anteriormente.";break;case"Fecha ya pasó":u+=` La fecha de mantenimiento (${m.maintenance_date}) ya ha pasado.`;break;default:u+=` Razón: ${m.reason}`}r(u,"error");return}}catch(l){console.error("Error verificando si se puede cancelar:",l),r("Error al verificar el ticket. Intenta nuevamente.","error");return}d&&(d.textContent=`¿Estás seguro que deseas cancelar el ticket ${t}? Esta acción no se puede deshacer.`),e&&(e.classList.remove("hidden"),e.classList.add("flex"))}}),c&&c.addEventListener("click",n),a&&a.addEventListener("click",function(){o&&g(o)}),e&&(document.addEventListener("keydown",function(s){s.key==="Escape"&&!e.classList.contains("hidden")&&n()}),e.addEventListener("click",function(s){s.target===e&&n()}));function n(){e&&(e.classList.add("hidden"),e.classList.remove("flex")),o=null,t=null}async function g(s){try{a&&(a.disabled=!0,a.textContent="Cancelando...");const i=await fetch(`${window.location.origin}/ticket/${s}`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}});if(i.ok)n(),r("Ticket cancelado exitosamente","success"),setTimeout(()=>{window.location.reload()},1500);else if(i.status===404)r("El ticket no fue encontrado.","error");else if(i.status===403)r("No tienes permisos para cancelar este ticket.","error");else throw new Error(`HTTP ${i.status}: ${i.statusText}`)}catch(i){console.error("Error:",i),r("Error al cancelar el ticket. Inténtalo de nuevo.","error")}finally{a&&(a.disabled=!1,a.textContent="Aceptar")}}}function v(){document.addEventListener("click",function(o){const t=o.target.closest("[data-acknowledge-update]");if(t){o.preventDefault();const n=t.dataset.ticketId;n&&c(n,t)}});const e=document.querySelector("[data-acknowledge-all]");e&&e.addEventListener("click",function(o){o.preventDefault(),a(this)});async function c(o,t){try{const n=t.textContent;if(t.disabled=!0,t.textContent="Marcando...",(await fetch(`${window.location.origin}/ticket/${o}/acknowledge-update`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}})).ok){const s=t.closest("[data-ticket-card]");if(s){const i=s.querySelector("[data-update-indicator]");i&&i.remove()}t.remove(),r("Actualización marcada como revisada","success"),d()}else throw new Error("Error al marcar como revisado")}catch(n){console.error("Error:",n),r("Error al marcar como revisado","error"),t.disabled=!1,t.textContent=originalText}}async function a(o){try{const t=o.textContent;if(o.disabled=!0,o.textContent="Marcando todos...",(await fetch(`${window.location.origin}/tickets/acknowledge-all`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}})).ok)r("Todas las actualizaciones marcadas como revisadas","success"),setTimeout(()=>{window.location.reload()},1500);else throw new Error("Error al marcar todos como revisados")}catch(t){console.error("Error:",t),r("Error al marcar todos como revisados","error"),o.disabled=!1,o.textContent=originalText}}function d(){const t=document.querySelectorAll("[data-update-indicator]").length,n=document.querySelector("[data-notification-count]");n&&(t>0?(n.textContent=t,n.classList.remove("hidden")):n.classList.add("hidden"))}}function r(e,c="info"){const a=document.createElement("div"),d=c==="success"?"bg-green-500":c==="error"?"bg-red-500":"bg-blue-500";a.className=`fixed top-4 right-4 ${d} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{a.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},300)},4e3)}window.initializeMyTickets=p;window.expandImage=w;window.closeImageModal=f;window.showNotification=r;
