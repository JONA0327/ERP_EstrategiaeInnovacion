document.addEventListener("DOMContentLoaded",function(){S()});function S(){console.log("üé´ Inicializando funcionalidad de Crear Ticket");const t=T();console.log(`üìù Tipo de ticket: ${t}`),q(),P(),F(),t==="mantenimiento"&&V()}function T(){const t=document.querySelector("[data-ticket-type]");return t?t.getAttribute("data-ticket-type"):"unknown"}function c(t,n="info"){const e=document.createElement("div"),a=n==="success"?"bg-green-500":n==="error"?"bg-red-500":n==="warning"?"bg-yellow-500":"bg-blue-500";e.className=`fixed top-4 right-4 ${a} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{e.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},4e3)}function q(){const t=document.querySelector("[data-ticket-create] form");t&&t.addEventListener("submit",function(n){if(!A())return n.preventDefault(),!1;const e=t.querySelector('button[type="submit"]');if(e){const a=e.textContent;e.disabled=!0,e.innerHTML=`
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creando ticket...
            `,setTimeout(()=>{e.disabled=!1,e.textContent=a},1e4)}})}function A(){const t=T();let n=!0;const e=document.getElementById("descripcion_problema");if(e&&t!=="mantenimiento"&&(e.value.trim()||(c("La descripci√≥n del problema es obligatoria","error"),e.focus(),n=!1)),t==="software"){const a=document.getElementById("nombre_programa");a&&!a.value&&(c("Debes seleccionar un programa","error"),a.focus(),n=!1)}if(t==="mantenimiento"){const a=document.getElementById("maintenance_slot_id");a&&!a.value&&(c("Debes seleccionar una fecha y horario para el mantenimiento","error"),n=!1)}return n}function F(){const t=document.getElementById("nombre_programa"),n=document.getElementById("otro_programa_nombre");if(!t||!n)return;function e(){const a=t.value==="Otro",l=n.closest("div");l&&(a?(l.style.display="block",n.required=!0,setTimeout(()=>n.focus(),100)):(l.style.display="none",n.required=!1,n.value=""))}t.addEventListener("change",e),e()}function P(){const t=document.getElementById("imageInput"),n=document.getElementById("imagePreview");if(document.querySelector(`button[onclick="document.getElementById('imageInput').click()"]`),!t||!n)return;let e=[];t.addEventListener("change",function(r){const h=Array.from(r.target.files).filter(u=>u.size>10*1024*1024?(c(`La imagen "${u.name}" es muy grande (m√°ximo 10MB)`,"warning"),!1):u.type.startsWith("image/")?!0:(c(`"${u.name}" no es una imagen v√°lida`,"warning"),!1));e=[...e,...h],e.length>10&&(e=e.slice(0,10),c("M√°ximo 10 im√°genes permitidas","warning")),a(),l()});function a(){if(e.length===0){n.innerHTML='<p class="text-sm text-slate-400 text-center py-8">Las im√°genes seleccionadas aparecer√°n aqu√≠</p>';return}n.innerHTML="",e.forEach((r,d)=>{const h=new FileReader;h.onload=function(u){const m=document.createElement("div");m.className="relative group",m.innerHTML=`
                    <img src="${u.target.result}" alt="Preview ${d+1}" 
                         class="h-24 w-24 rounded-xl object-cover shadow-md transition group-hover:shadow-lg">
                    <button type="button" 
                            onclick="removeImage(${d})"
                            class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-white shadow-lg transition hover:bg-red-600 hover:scale-110">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition rounded-xl flex items-center justify-center">
                        <span class="text-white text-xs font-medium">Ver</span>
                    </div>
                `,m.querySelector("img").addEventListener("click",()=>U(u.target.result,`Imagen ${d+1}`)),n.appendChild(m)},h.readAsDataURL(r)})}function l(){const r=new DataTransfer;e.forEach(d=>{d&&r.items.add(d)}),t.files=r.files}window.removeImage=function(r){e.splice(r,1),a(),l(),e.length===0&&c("Imagen eliminada","info")}}function U(t,n){let e=document.getElementById("imageExpandModal");e||(e=O());const a=e.querySelector("#expandedImage"),l=e.querySelector("#expandedImageTitle");a.src=t,a.alt=n,l.textContent=n,e.classList.remove("hidden"),e.classList.add("flex"),document.body.style.overflow="hidden"}function O(){const t=document.createElement("div");return t.id="imageExpandModal",t.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",t.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeExpandedImage()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="expandedImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="expandedImageTitle" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.addEventListener("keydown",function(n){n.key==="Escape"&&!t.classList.contains("hidden")&&closeExpandedImage()}),t.addEventListener("click",function(n){n.target===t&&closeExpandedImage()}),document.body.appendChild(t),t}window.closeExpandedImage=function(){const t=document.getElementById("imageExpandModal");t&&(t.classList.add("hidden"),t.classList.remove("flex"),document.body.style.overflow="")};function V(){console.log("üîß Inicializando calendario de mantenimiento");const t=document.getElementById("maintenanceScheduling");if(!t)return;const n=t.getAttribute("data-availability-url"),e=t.getAttribute("data-slots-url");if(!n||!e){console.error("URLs de mantenimiento no configuradas");return}let a=new Date,l={};const r=document.getElementById("maintenanceCalendar"),d=document.getElementById("calendarPrev"),h=document.getElementById("calendarNext"),u=document.getElementById("currentMonth"),m=document.getElementById("timeSlotsWrapper"),v=document.getElementById("timeSlotsList"),k=document.getElementById("selectedDateLabel"),w=document.getElementById("selectedSlotLabel"),x=document.getElementById("noSlotsMessage"),E=document.getElementById("maintenance_slot_id"),I=document.getElementById("maintenance_selected_date");B(),d&&d.addEventListener("click",()=>M(-1)),h&&h.addEventListener("click",()=>M(1));async function B(){try{const o=await fetch(n);if(!o.ok)throw new Error("Error al cargar disponibilidad");l=await o.json(),C()}catch(o){console.error("Error loading availability:",o),c("Error al cargar la disponibilidad del calendario","error")}}function M(o){a.setMonth(a.getMonth()+o),C(),z()}function C(){if(!r||!u)return;const o=a.toLocaleDateString("es-ES",{month:"long",year:"numeric"});u.textContent=o.charAt(0).toUpperCase()+o.slice(1),r.innerHTML="",["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"].forEach(s=>{const p=document.createElement("div");p.className="p-2 text-center text-xs font-semibold text-slate-600 bg-slate-100 rounded-lg",p.textContent=s,r.appendChild(p)});const b=new Date(a.getFullYear(),a.getMonth(),1);new Date(a.getFullYear(),a.getMonth()+1,0);const y=new Date(b);y.setDate(y.getDate()-b.getDay());const f=new Date;f.setHours(0,0,0,0);for(let s=0;s<42;s++){const p=new Date(y);p.setDate(y.getDate()+s);const i=document.createElement("button");i.type="button",i.className="h-12 w-full rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105",i.textContent=p.getDate();const D=p.toISOString().split("T")[0],L=l[D],H=p.getMonth()===a.getMonth(),j=p<f;H?j?(i.className+=" text-slate-400 cursor-not-allowed bg-slate-100",i.disabled=!0):L?L.available_slots>0?i.className+=" bg-green-100 text-green-800 hover:bg-green-200 border border-green-200":L.total_slots>0?(i.className+=" bg-yellow-100 text-yellow-800 cursor-not-allowed border border-yellow-200",i.disabled=!0):(i.className+=" text-slate-400 cursor-not-allowed bg-slate-100",i.disabled=!0):(i.className+=" bg-red-100 text-red-800 cursor-not-allowed border border-red-200",i.disabled=!0):(i.className+=" text-slate-300 cursor-not-allowed bg-slate-50",i.disabled=!0),i.disabled||i.addEventListener("click",()=>_(D)),r.appendChild(i)}}async function _(o){try{const g=await fetch(`${e}?date=${o}`);if(!g.ok)throw new Error("Error al cargar horarios");const b=await g.json();$(b,o)}catch(g){console.error("Error loading slots:",g),c("Error al cargar los horarios disponibles","error")}}function $(o,g){if(!v||!m)return;const y=new Date(g).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});if(k&&(k.textContent=y.charAt(0).toUpperCase()+y.slice(1)),v.innerHTML="",o.length===0){x&&x.classList.remove("hidden"),m.classList.add("hidden");return}x&&x.classList.add("hidden"),o.forEach(f=>{const s=document.createElement("button");s.type="button",s.className=`p-4 rounded-2xl border-2 transition-all duration-200 text-left hover:scale-105 ${f.available_capacity>0?"border-green-200 bg-green-50 hover:border-green-300 hover:bg-green-100":"border-gray-200 bg-gray-50 cursor-not-allowed opacity-50"}`,s.innerHTML=`
                <div class="font-semibold text-slate-900">${f.start_time} - ${f.end_time}</div>
                <div class="text-sm text-slate-600 mt-1">
                    Disponibles: ${f.available_capacity}/${f.capacity}
                </div>
            `,f.available_capacity>0?s.addEventListener("click",()=>N(f,g)):s.disabled=!0,v.appendChild(s)}),m.classList.remove("hidden")}function N(o,g){o.id,E&&(E.value=o.id),I&&(I.value=g),w&&(w.textContent=`Horario: ${o.start_time} - ${o.end_time}`),document.querySelectorAll("#timeSlotsList button").forEach(b=>{b.classList.remove("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),b.classList.add("border-green-200","bg-green-50")}),event.target.closest("button").classList.remove("border-green-200","bg-green-50"),event.target.closest("button").classList.add("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),c(`Horario seleccionado: ${o.start_time} - ${o.end_time}`,"success")}function z(){m&&m.classList.add("hidden"),w&&(w.textContent=""),E&&(E.value=""),I&&(I.value="")}}window.initializeTicketCreate=S;window.showNotification=c;window.closeExpandedImage=closeExpandedImage;console.log("‚úÖ Tickets-create.js cargado correctamente");
