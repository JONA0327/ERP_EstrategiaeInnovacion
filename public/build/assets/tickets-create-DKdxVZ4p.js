document.addEventListener("DOMContentLoaded",function(){T()});function T(){const t=B();P(),q(),z(),t==="mantenimiento"&&N()}function N(){const t=document.getElementById("maintenanceScheduling");if(!t)return;const n=document.getElementById("calendarGrid"),e=document.getElementById("calendarMonthLabel"),r=document.getElementById("calendarPrev"),b=document.getElementById("calendarNext"),p=t.getAttribute("data-availability-url"),y=t.getAttribute("data-slots-url");if(!n||!e){console.error("❌ Elementos del calendario no encontrados");return}if(!p||!y){console.error("❌ URLs de API no configuradas");return}let u=new Date,g={};async function h(){try{const o=u.toISOString().substr(0,7),d=`${p}?month=${o}`,a=await fetch(d);if(!a.ok){if(console.error("❌ API Error. Status:",a.status,a.statusText),window.forceRealAPI){f(`Error de API: ${a.status} - ${a.statusText}`,"error");return}g=_(),x();return}const s=await a.json();g={},s.days&&Array.isArray(s.days)&&s.days.forEach(l=>{g[l.date]=l}),x()}catch(o){if(console.error("❌ Error cargando disponibilidad:",o),window.forceRealAPI){f(`Error de conexión: ${o.message}`,"error");return}console.log("Usando datos de prueba como fallback"),g=_(),f("Usando datos de prueba (API no disponible)","info"),x()}}function _(){const o=new Date,d={};for(let a=0;a<30;a++){const s=new Date(o);s.setDate(o.getDate()+a);const l=s.toISOString().split("T")[0];a%4===0?d[l]={available_slots:4,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!0},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!0},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:a%4===1?d[l]={available_slots:2,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:a%4===2&&(d[l]={available_slots:0,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!1},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!1}]})}return d}function x(){const o=u.toLocaleDateString("es-ES",{month:"long",year:"numeric"});e.textContent=o.charAt(0).toUpperCase()+o.slice(1),n.innerHTML="";const d=new Date(u.getFullYear(),u.getMonth(),1),a=new Date(d);a.setDate(a.getDate()-d.getDay());const s=new Date;s.setHours(0,0,0,0);for(let l=0;l<35;l++){const m=new Date(a);m.setDate(a.getDate()+l);const i=document.createElement("button");i.type="button",i.textContent=m.getDate(),i.className="h-10 w-full rounded-lg text-sm font-medium transition-colors";const w=m.toISOString().split("T")[0],c=g[w],v=m.getMonth()===u.getMonth(),L=m<s;v?L?(i.className+=" text-gray-400 bg-gray-100 cursor-not-allowed",i.disabled=!0):c?c.available_slots>0?(i.className+=" bg-green-100 text-green-800 hover:bg-green-200 border border-green-200",i.addEventListener("click",()=>D(w,m))):c.total_slots>0&&c.booked>0&&c.booked<c.total_capacity?(i.className+=" bg-yellow-100 text-yellow-800 hover:bg-yellow-200 border border-yellow-200",i.addEventListener("click",()=>D(w,m))):c.total_slots>0?(i.className+=" bg-blue-100 text-blue-800 cursor-not-allowed border border-blue-200",i.disabled=!0):(i.className+=" text-gray-400 cursor-not-allowed bg-gray-100",i.disabled=!0):(i.className+=" bg-red-100 text-red-800 cursor-not-allowed border border-red-200",i.disabled=!0):(i.className+=" text-gray-300 bg-gray-50 cursor-not-allowed",i.disabled=!0),n.appendChild(i)}}async function D(o,d){try{const a=await fetch(`${y}?date=${o}`);if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const l=(await a.json()).slots||[];M(l,o,d)}catch(a){console.error("❌ Error cargando horarios:",a),f("Error al cargar los horarios disponibles","error")}}function M(o,d,a){const s=document.getElementById("timeSlotsWrapper"),l=document.getElementById("timeSlotsList"),m=document.getElementById("selectedDateLabel"),i=document.getElementById("noSlotsMessage");if(!s||!l){console.error("❌ Elementos de horarios no encontrados");return}const w=a.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});if(m&&(m.textContent=w.charAt(0).toUpperCase()+w.slice(1)),l.innerHTML="",o.length===0){i&&i.classList.remove("hidden"),s.classList.add("hidden");return}if(i&&i.classList.add("hidden"),!Array.isArray(o)){console.error("❌ slots no es un array:",typeof o,o),i&&i.classList.remove("hidden"),s.classList.add("hidden");return}o.forEach(c=>{const v=document.createElement("button");v.type="button";const L=c.available>0||c.status==="available",$=c.start||c.start_time||"N/D",A=c.end||c.end_time||"N/D";let E="Desconocido",I="text-red-600";switch(c.status){case"available":E="Disponible",I="text-green-600";break;case"partial":E="Parcial",I="text-yellow-600";break;case"full":E="Ocupado",I="text-blue-600";break;case"past":E="Pasado",I="text-gray-600";break}v.className=`p-4 rounded-2xl border-2 transition-all text-left hover:scale-105 ${L?"border-green-200 bg-green-50 hover:border-green-300 hover:bg-green-100":"border-gray-200 bg-gray-50 cursor-not-allowed opacity-50"}`,v.innerHTML=`
                <div class="font-semibold text-slate-900">${$} - ${A}</div>
                <div class="text-sm text-slate-600 mt-1">
                    Disponibles: ${c.available||0}/${c.capacity||1}
                </div>
                <div class="text-xs mt-1">
                    Estado: <span class="${I}">${E}</span>
                </div>
            `,L?v.addEventListener("click",()=>C(c,d)):v.disabled=!0,l.appendChild(v)}),s.classList.remove("hidden")}function C(o,d){const a=document.getElementById("maintenance_slot_id"),s=document.getElementById("maintenance_selected_date"),l=document.getElementById("selectedSlotLabel");if(a&&(a.value=o.id),s&&(s.value=d),l){const m=o.start||o.start_time||"N/A",i=o.end||o.end_time||"N/A";l.textContent=`Horario: ${m} - ${i}`}document.querySelectorAll("#timeSlotsList button").forEach(m=>{m.classList.remove("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),m.classList.add("border-green-200","bg-green-50")}),event.target.closest("button").classList.remove("border-green-200","bg-green-50"),event.target.closest("button").classList.add("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),f(`Horario seleccionado: ${o.start_time} - ${o.end_time}`,"success")}r&&r.addEventListener("click",()=>{u.setMonth(u.getMonth()-1),x(),S()}),b&&b.addEventListener("click",()=>{u.setMonth(u.getMonth()+1),x(),S()});function S(){const o=document.getElementById("timeSlotsWrapper"),d=document.getElementById("selectedSlotLabel"),a=document.getElementById("maintenance_slot_id"),s=document.getElementById("maintenance_selected_date");o&&o.classList.add("hidden"),d&&(d.textContent=""),a&&(a.value=""),s&&(s.value="")}h()}function B(){const t=document.querySelector("[data-ticket-type]");return t?t.getAttribute("data-ticket-type"):"unknown"}function f(t,n="info"){const e=document.createElement("div"),r=n==="success"?"bg-green-500":n==="error"?"bg-red-500":n==="warning"?"bg-yellow-500":"bg-blue-500";e.className=`fixed top-4 right-4 ${r} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{e.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},4e3)}function P(){const t=document.querySelector("[data-ticket-create] form");t&&t.addEventListener("submit",function(n){if(!H())return n.preventDefault(),!1;const e=t.querySelector('button[type="submit"]');if(e){const r=e.textContent;e.disabled=!0,e.innerHTML=`
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creando ticket...
            `,setTimeout(()=>{e.disabled=!1,e.textContent=r},1e4)}})}function H(){const t=B();let n=!0;const e=document.getElementById("descripcion_problema");if(e&&t!=="mantenimiento"&&(e.value.trim()||(f("La descripción del problema es obligatoria","error"),e.focus(),n=!1)),t==="software"){const r=document.getElementById("nombre_programa");r&&!r.value&&(f("Debes seleccionar un programa","error"),r.focus(),n=!1)}if(t==="mantenimiento"){const r=document.getElementById("maintenance_slot_id");r&&!r.value&&(f("Debes seleccionar una fecha y horario para el mantenimiento","error"),n=!1)}return n}function z(){const t=document.getElementById("nombre_programa"),n=document.getElementById("otro_programa_nombre");if(!t||!n)return;function e(){const r=t.value==="Otro",b=n.closest("div");b&&(r?(b.style.display="block",n.required=!0,setTimeout(()=>n.focus(),100)):(b.style.display="none",n.required=!1,n.value=""))}t.addEventListener("change",e),e()}function q(){const t=document.getElementById("imageInput"),n=document.getElementById("imagePreview");if(document.querySelector(`button[onclick="document.getElementById('imageInput').click()"]`),!t||!n)return;let e=[];t.addEventListener("change",function(p){const u=Array.from(p.target.files).filter(g=>g.size>10*1024*1024?(f(`La imagen "${g.name}" es muy grande (máximo 10MB)`,"warning"),!1):g.type.startsWith("image/")?!0:(f(`"${g.name}" no es una imagen válida`,"warning"),!1));e=[...e,...u],e.length>10&&(e=e.slice(0,10),f("Máximo 10 imágenes permitidas","warning")),r(),b()});function r(){if(e.length===0){n.innerHTML='<p class="text-sm text-slate-400 text-center py-8">Las imágenes seleccionadas aparecerán aquí</p>';return}n.innerHTML="",e.forEach((p,y)=>{const u=new FileReader;u.onload=function(g){const h=document.createElement("div");h.className="relative group",h.innerHTML=`
                    <img src="${g.target.result}" alt="Preview ${y+1}" 
                         class="h-24 w-24 rounded-xl object-cover shadow-md transition group-hover:shadow-lg">
                    <button type="button" 
                            onclick="removeImage(${y})"
                            class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-white shadow-lg transition hover:bg-red-600 hover:scale-110">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition rounded-xl flex items-center justify-center">
                        <span class="text-white text-xs font-medium">Ver</span>
                    </div>
                `,h.querySelector("img").addEventListener("click",()=>j(g.target.result,`Imagen ${y+1}`)),n.appendChild(h)},u.readAsDataURL(p)})}function b(){const p=new DataTransfer;e.forEach(y=>{y&&p.items.add(y)}),t.files=p.files}window.removeImage=function(p){e.splice(p,1),r(),b(),e.length===0&&f("Imagen eliminada","info")}}function j(t,n){let e=document.getElementById("imageExpandModal");e||(e=U());const r=e.querySelector("#expandedImage"),b=e.querySelector("#expandedImageTitle");r.src=t,r.alt=n,b.textContent=n,e.classList.remove("hidden"),e.classList.add("flex"),document.body.style.overflow="hidden"}function U(){const t=document.createElement("div");return t.id="imageExpandModal",t.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",t.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeExpandedImage()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="expandedImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="expandedImageTitle" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.addEventListener("keydown",function(n){n.key==="Escape"&&!t.classList.contains("hidden")&&k()}),t.addEventListener("click",function(n){n.target===t&&k()}),document.body.appendChild(t),t}function k(){const t=document.getElementById("imageExpandModal");t&&(t.classList.add("hidden"),t.classList.remove("flex"),document.body.style.overflow="")}window.initializeTicketCreate=T;window.showNotification=f;window.closeExpandedImage=k;
