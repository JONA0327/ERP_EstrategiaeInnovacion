document.addEventListener("DOMContentLoaded",function(){g()});function g(){console.log("ðŸŽ« Inicializando funcionalidad de Mis Tickets"),k(),h(),w()}function k(){let e=document.getElementById("imageModal");e||(e=p()),document.addEventListener("keydown",function(c){c.key==="Escape"&&e&&!e.classList.contains("hidden")&&closeImageModal()}),e&&e.addEventListener("click",function(c){c.target===e&&closeImageModal()})}function p(){const e=document.createElement("div");return e.id="imageModal",e.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",e.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeImageModal()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="modalImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="modalImageName" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.body.appendChild(e),e}window.expandImage=function(e){const c=document.getElementById("imageModal"),t=document.getElementById("modalImage"),r=document.getElementById("modalImageName");c&&t&&(t.src=e.src,t.alt=e.alt,r&&(r.textContent=e.alt||"Imagen del ticket"),c.classList.remove("hidden"),c.classList.add("flex"))};window.closeImageModal=function(){const e=document.getElementById("imageModal");e&&(e.classList.add("hidden"),e.classList.remove("flex"))};function h(){const e=document.getElementById("cancelModal"),c=document.getElementById("cancelModalClose"),t=document.getElementById("cancelModalConfirm"),r=document.getElementById("cancelModalMessage");let o=null,a=null;document.addEventListener("click",async function(i){const s=i.target.closest("[data-cancel-ticket]");if(s){i.preventDefault(),o=s.dataset.ticketId,a=s.dataset.ticketFolio;try{const m=await(await fetch(`/ticket/${o}/can-cancel`)).json();if(!m.can_cancel){let l=`No se puede cancelar el ticket ${a}.`;switch(m.reason){case"Sin permisos":l+=" No tienes permisos suficientes.";break;case"Ya cancelado":l+=" El ticket ya fue cancelado anteriormente.";break;case"Fecha ya pasÃ³":l+=` La fecha de mantenimiento (${m.maintenance_date}) ya ha pasado.`;break;default:l+=` RazÃ³n: ${m.reason}`}d(l,"error");return}}catch(u){console.error("Error verificando si se puede cancelar:",u),d("Error al verificar el ticket. Intenta nuevamente.","error");return}r&&(r.textContent=`Â¿EstÃ¡s seguro que deseas cancelar el ticket ${a}? Esta acciÃ³n no se puede deshacer.`),e&&(e.classList.remove("hidden"),e.classList.add("flex"))}}),c&&c.addEventListener("click",n),t&&t.addEventListener("click",function(){o&&f(o)}),e&&(document.addEventListener("keydown",function(i){i.key==="Escape"&&!e.classList.contains("hidden")&&n()}),e.addEventListener("click",function(i){i.target===e&&n()}));function n(){e&&(e.classList.add("hidden"),e.classList.remove("flex")),o=null,a=null}async function f(i){try{t&&(t.disabled=!0,t.textContent="Cancelando...");const s=await fetch(`/ticket/${i}`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}});if(s.ok){n();const u=await s.text();d("Ticket cancelado exitosamente","success"),setTimeout(()=>{window.location.reload()},1500)}else throw new Error("Error al cancelar el ticket")}catch(s){console.error("Error:",s),d("Error al cancelar el ticket. IntÃ©ntalo de nuevo.","error")}finally{t&&(t.disabled=!1,t.textContent="Aceptar")}}}function w(){document.addEventListener("click",function(o){const a=o.target.closest("[data-acknowledge-update]");if(a){o.preventDefault();const n=a.dataset.ticketId;n&&c(n,a)}});const e=document.querySelector("[data-acknowledge-all]");e&&e.addEventListener("click",function(o){o.preventDefault(),t(this)});async function c(o,a){try{const n=a.textContent;if(a.disabled=!0,a.textContent="Marcando...",(await fetch(`/ticket/${o}/acknowledge-update`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}})).ok){const i=a.closest("[data-ticket-card]");if(i){const s=i.querySelector("[data-update-indicator]");s&&s.remove()}a.remove(),d("ActualizaciÃ³n marcada como revisada","success"),r()}else throw new Error("Error al marcar como revisado")}catch(n){console.error("Error:",n),d("Error al marcar como revisado","error"),a.disabled=!1,a.textContent=originalText}}async function t(o){try{const a=o.textContent;if(o.disabled=!0,o.textContent="Marcando todos...",(await fetch("/tickets/acknowledge-all",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""}})).ok)d("Todas las actualizaciones marcadas como revisadas","success"),setTimeout(()=>{window.location.reload()},1500);else throw new Error("Error al marcar todos como revisados")}catch(a){console.error("Error:",a),d("Error al marcar todos como revisados","error"),o.disabled=!1,o.textContent=originalText}}function r(){const a=document.querySelectorAll("[data-update-indicator]").length,n=document.querySelector("[data-notification-count]");n&&(a>0?(n.textContent=a,n.classList.remove("hidden")):n.classList.add("hidden"))}}function d(e,c="info"){const t=document.createElement("div"),r=c==="success"?"bg-green-500":c==="error"?"bg-red-500":"bg-blue-500";t.className=`fixed top-4 right-4 ${r} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{t.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},4e3)}window.initializeMyTickets=g;window.expandImage=expandImage;window.closeImageModal=closeImageModal;window.showNotification=d;console.log("âœ… Tickets-my.js cargado correctamente");
