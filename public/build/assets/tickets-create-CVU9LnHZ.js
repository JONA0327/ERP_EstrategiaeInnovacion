document.addEventListener("DOMContentLoaded",function(){C()});function C(){const e=M();P(),j(),z(),e==="mantenimiento"&&N()}function N(){const e=document.getElementById("maintenanceScheduling");if(!e)return;const n=document.getElementById("calendarGrid"),t=document.getElementById("calendarMonthLabel"),s=document.getElementById("calendarPrev"),l=document.getElementById("calendarNext"),x=e.getAttribute("data-availability-url"),L=e.getAttribute("data-slots-url");if(!n||!t){console.error("❌ Elementos del calendario no encontrados");return}if(!x||!L){console.error("❌ URLs de API no configuradas");return}let f=new Date,h={};async function b(){try{const o=f.toISOString().substr(0,7),c=`${x}?month=${o}`,a=await fetch(c);if(!a.ok){if(console.error("❌ API Error. Status:",a.status,a.statusText),window.forceRealAPI){g(`Error de API: ${a.status} - ${a.statusText}`,"error");return}h=p(),v();return}const r=await a.json();h={},r.days&&Array.isArray(r.days)&&r.days.forEach(d=>{h[d.date]=d}),v()}catch(o){if(console.error("❌ Error cargando disponibilidad:",o),window.forceRealAPI){g(`Error de conexión: ${o.message}`,"error");return}console.log("Usando datos de prueba como fallback"),h=p(),g("Usando datos de prueba (API no disponible)","info"),v()}}function p(){const o=new Date,c={};for(let a=0;a<30;a++){const r=new Date(o);r.setDate(o.getDate()+a);const d=r.toISOString().split("T")[0];a%4===0?c[d]={available_slots:4,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!0},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!0},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:a%4===1?c[d]={available_slots:2,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!0},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!0}]}:a%4===2&&(c[d]={available_slots:0,total_slots:4,slots:[{id:1,start_time:"09:00",end_time:"10:00",available:!1},{id:2,start_time:"10:00",end_time:"11:00",available:!1},{id:3,start_time:"14:00",end_time:"15:00",available:!1},{id:4,start_time:"15:00",end_time:"16:00",available:!1}]})}return c}function v(){const o=f.toLocaleDateString("es-ES",{month:"long",year:"numeric"});t.textContent=o.charAt(0).toUpperCase()+o.slice(1),n.innerHTML="";const c=new Date(f.getFullYear(),f.getMonth(),1),a=new Date(c);a.setDate(a.getDate()-c.getDay());const r=new Date;r.setHours(0,0,0,0);for(let d=0;d<35;d++){const u=new Date(a);u.setDate(a.getDate()+d);const i=document.createElement("button");i.type="button",i.textContent=u.getDate(),i.className="h-10 w-full rounded-lg text-sm font-medium transition-colors";const I=u.toISOString().split("T")[0],m=h[I],w=u.getMonth()===f.getMonth(),D=u<r;w?D?(i.className+=" text-gray-400 bg-gray-100 cursor-not-allowed",i.disabled=!0):m?m.available_slots>0?(i.className+=" bg-green-100 text-green-800 hover:bg-green-200 border border-green-200",i.addEventListener("click",()=>y(I,u))):m.total_slots>0&&m.booked>0&&m.booked<m.total_capacity?(i.className+=" bg-yellow-100 text-yellow-800 hover:bg-yellow-200 border border-yellow-200",i.addEventListener("click",()=>y(I,u))):m.total_slots>0?(i.className+=" bg-blue-100 text-blue-800 cursor-not-allowed border border-blue-200",i.disabled=!0):(i.className+=" text-gray-400 cursor-not-allowed bg-gray-100",i.disabled=!0):(i.className+=" bg-red-100 text-red-800 cursor-not-allowed border border-red-200",i.disabled=!0):(i.className+=" text-gray-300 bg-gray-50 cursor-not-allowed",i.disabled=!0),n.appendChild(i)}}async function y(o,c){try{const a=await fetch(`${L}?date=${o}`);if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const d=(await a.json()).slots||[];E(d,o,c)}catch(a){console.error("❌ Error cargando horarios:",a),g("Error al cargar los horarios disponibles","error")}}function E(o,c,a){const r=document.getElementById("timeSlotsWrapper"),d=document.getElementById("timeSlotsList"),u=document.getElementById("selectedDateLabel"),i=document.getElementById("noSlotsMessage");if(!r||!d){console.error("❌ Elementos de horarios no encontrados");return}const I=a.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});if(u&&(u.textContent=I.charAt(0).toUpperCase()+I.slice(1)),d.innerHTML="",o.length===0){i&&i.classList.remove("hidden"),r.classList.add("hidden");return}if(i&&i.classList.add("hidden"),!Array.isArray(o)){console.error("❌ slots no es un array:",typeof o,o),i&&i.classList.remove("hidden"),r.classList.add("hidden");return}o.forEach(m=>{const w=document.createElement("button");w.type="button";const D=m.available>0||m.status==="available",$=m.start||m.start_time||"N/D",A=m.end||m.end_time||"N/D";let _="Desconocido",k="text-red-600";switch(m.status){case"available":_="Disponible",k="text-green-600";break;case"partial":_="Parcial",k="text-yellow-600";break;case"full":_="Ocupado",k="text-blue-600";break;case"past":_="Pasado",k="text-gray-600";break}w.className=`p-4 rounded-2xl border-2 transition-all text-left hover:scale-105 ${D?"border-green-200 bg-green-50 hover:border-green-300 hover:bg-green-100":"border-gray-200 bg-gray-50 cursor-not-allowed opacity-50"}`,w.innerHTML=`
                <div class="font-semibold text-slate-900">${$} - ${A}</div>
                <div class="text-sm text-slate-600 mt-1">
                    Disponibles: ${m.available||0}/${m.capacity||1}
                </div>
                <div class="text-xs mt-1">
                    Estado: <span class="${k}">${_}</span>
                </div>
            `,D?w.addEventListener("click",()=>T(m,c)):w.disabled=!0,d.appendChild(w)}),r.classList.remove("hidden")}function T(o,c){const a=document.getElementById("maintenance_slot_id"),r=document.getElementById("maintenance_selected_date"),d=document.getElementById("selectedSlotLabel");if(a&&(a.value=o.id),r&&(r.value=c),d){const u=o.start||o.start_time||"N/A",i=o.end||o.end_time||"N/A";d.textContent=`Horario: ${u} - ${i}`}document.querySelectorAll("#timeSlotsList button").forEach(u=>{u.classList.remove("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),u.classList.add("border-green-200","bg-green-50")}),event.target.closest("button").classList.remove("border-green-200","bg-green-50"),event.target.closest("button").classList.add("border-blue-300","bg-blue-100","ring-2","ring-blue-200"),g(`Horario seleccionado: ${o.start_time} - ${o.end_time}`,"success")}s&&s.addEventListener("click",()=>{f.setMonth(f.getMonth()-1),v(),B()}),l&&l.addEventListener("click",()=>{f.setMonth(f.getMonth()+1),v(),B()});function B(){const o=document.getElementById("timeSlotsWrapper"),c=document.getElementById("selectedSlotLabel"),a=document.getElementById("maintenance_slot_id"),r=document.getElementById("maintenance_selected_date");o&&o.classList.add("hidden"),c&&(c.textContent=""),a&&(a.value=""),r&&(r.value="")}b()}function M(){const e=document.querySelector("[data-ticket-type]");return e?e.getAttribute("data-ticket-type"):"unknown"}function g(e,n="info"){const t=document.createElement("div"),s=n==="success"?"bg-green-500":n==="error"?"bg-red-500":n==="warning"?"bg-yellow-500":"bg-blue-500";t.className=`fixed top-4 right-4 ${s} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.remove("translate-x-full","opacity-0")},100),setTimeout(()=>{t.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},4e3)}function P(){const e=document.querySelector("[data-ticket-create] form");e&&e.addEventListener("submit",function(n){if(!H())return n.preventDefault(),!1;const t=e.querySelector('button[type="submit"]');if(t){const s=t.textContent;t.disabled=!0,t.innerHTML=`
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creando ticket...
            `,setTimeout(()=>{t.disabled=!1,t.textContent=s},1e4)}})}function H(){const e=M();let n=!0;const t=document.getElementById("descripcion_problema");if(t&&e!=="mantenimiento"&&(t.value.trim()||(g("La descripción del problema es obligatoria","error"),t.focus(),n=!1)),e==="software"){const s=document.getElementById("nombre_programa");s&&!s.value&&(g("Debes seleccionar un programa","error"),s.focus(),n=!1)}if(e==="mantenimiento"){const s=document.getElementById("maintenance_slot_id");s&&!s.value&&(g("Debes seleccionar una fecha y horario para el mantenimiento","error"),n=!1)}return n}function z(){const e=document.getElementById("nombre_programa"),n=document.getElementById("otro_programa_nombre");if(!e||!n)return;function t(){const s=e.value==="Otro",l=n.closest("div");l&&(s?(l.style.display="block",n.required=!0,setTimeout(()=>n.focus(),100)):(l.style.display="none",n.required=!1,n.value=""))}e.addEventListener("change",t),t()}function j(){const e=document.getElementById("imageInput"),n=document.getElementById("imagePreview"),t=document.getElementById("uploadButton"),s=document.getElementById("imageCount");if(!e||!n){console.log("No se encontraron elementos de imagen, posiblemente no es un ticket de software/hardware");return}let l=[];const x=5;t&&t.addEventListener("click",function(b){b.preventDefault(),e.click()}),e.addEventListener("change",function(b){const v=Array.from(b.target.files).filter(y=>y.size>10*1024*1024?(g(`La imagen "${y.name}" es muy grande (máximo 10MB)`,"warning"),!1):y.type.startsWith("image/")?!0:(g(`"${y.name}" no es una imagen válida`,"warning"),!1));l=[...l,...v],l.length>x&&(l=l.slice(0,x),g(`Máximo ${x} imágenes permitidas`,"warning")),f(),h(),L()});function L(){s&&(s.textContent=`${l.length}/${x} imágenes`)}function f(){if(l.length===0){n.innerHTML='<p class="text-sm text-slate-400 text-center py-8 col-span-full">Las imágenes seleccionadas aparecerán aquí</p>';return}n.innerHTML="",l.forEach((b,p)=>{const v=new FileReader;v.onload=function(y){const E=document.createElement("div");E.className="relative group",E.innerHTML=`
                    <img src="${y.target.result}" alt="Preview ${p+1}" 
                         class="h-24 w-24 rounded-xl object-cover shadow-md transition group-hover:shadow-lg">
                    <button type="button" 
                            onclick="removeImage(${p})"
                            class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-500 text-white shadow-lg transition hover:bg-red-600 hover:scale-110">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition rounded-xl flex items-center justify-center">
                        <span class="text-white text-xs font-medium">Ver</span>
                    </div>
                `,E.querySelector("img").addEventListener("click",()=>q(y.target.result,`Imagen ${p+1}`)),n.appendChild(E)},v.readAsDataURL(b)})}function h(){const b=new DataTransfer;l.forEach(p=>{p&&b.items.add(p)}),e.files=b.files}window.removeImage=function(b){l.splice(b,1),f(),h(),L(),l.length===0&&g("Imagen eliminada","info")}}function q(e,n){let t=document.getElementById("imageExpandModal");t||(t=U());const s=t.querySelector("#expandedImage"),l=t.querySelector("#expandedImageTitle");s.src=e,s.alt=n,l.textContent=n,t.classList.remove("hidden"),t.classList.add("flex"),document.body.style.overflow="hidden"}function U(){const e=document.createElement("div");return e.id="imageExpandModal",e.className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4",e.innerHTML=`
        <div class="relative max-w-[95vw] max-h-[95vh] flex items-center justify-center">
            <button onclick="closeExpandedImage()" 
                    class="absolute -top-4 -right-4 z-10 h-10 w-10 rounded-full bg-white/90 text-gray-800 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-6 w-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="expandedImage" src="" alt="" 
                 class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl bg-white">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 rounded-b-lg">
                <p id="expandedImageTitle" class="text-sm font-medium text-center"></p>
            </div>
        </div>
    `,document.addEventListener("keydown",function(n){n.key==="Escape"&&!e.classList.contains("hidden")&&S()}),e.addEventListener("click",function(n){n.target===e&&S()}),document.body.appendChild(e),e}function S(){const e=document.getElementById("imageExpandModal");e&&(e.classList.add("hidden"),e.classList.remove("flex"),document.body.style.overflow="")}window.initializeTicketCreate=C;window.showNotification=g;window.closeExpandedImage=S;
